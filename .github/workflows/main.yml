name: Cypress Tests

on:
   push:
      branches:
         - main
         - testing

jobs:
   cypresV10-run:
      runs-on: ubuntu-18.04
      steps:
         - uses: actions/checkout@v3

         # install a specific version of Node using
         - name: Use Node.js V16
           uses: actions/setup-node@v3
           with:
              node-version: "16.14.2"

         # Restore the previous NPM modules and Cypress binary archives.
         - name: Cache central NPM modules
           uses: actions/cache@v1
           with:
              path: ~/.npm
              key: ${{ runner.os }}-node-${{ github.ref }}-${{ hashFiles('**/package-lock.json') }}
              restore-keys: |
                 ${{ runner.os }}-node-${{ github.ref }}-${{ hashFiles('**/package-lock.json') }}

         - name: Cache Cypress binary
           uses: actions/cache@v1
           with:
              path: ~/.cache/Cypress
              key: cypress-${{ runner.os }}-cypress-${{ hashFiles('**/package.json') }}
              restore-keys: |
                 cypress-${{ runner.os }}-cypress-

         - name: Running cypress V10
           id: runningcypress
           uses: cypress-io/github-action@v4
           with:
              config-file: cypress.config.js
              build: npm install
              start: npm run testcli

         - name: Generate Cucumber report
           if: always()
           run: npm run report

         - name: Save Cucumber reporter
           if: always()
           uses: actions/upload-artifact@v3
           with:
              name: Cucumber report ${{ matrix.os }}
              path: reports/

         - name: Save screenshots report
           if: failure() && steps.runningcypress.outcome != 'success'
           uses: actions/upload-artifact@v3
           with:
              name: Screenshots report
              path: cypress/screenshots

         - name: Save video report
           if: failure() && steps.runningcypress.outcome != 'success'
           uses: actions/upload-artifact@v3
           with:
              name: Video report
              path: cypress/videos

         - name: Download all workflow run artifacts
           if: always()
           uses: actions/download-artifact@v3
